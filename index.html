<!DOCTYPE html>
<html>
<head lang="zh-cn">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>BTCPool算力导出工具</title>
	<meta name="renderer" content="webkit">
	<link rel="stylesheet" href="./css/amazeui.css"/>
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
	<script src="https://cdn.bootcss.com/react/15.4.2/react.js"></script>
	<script src="https://cdn.bootcss.com/react/15.4.2/react-dom.js"></script>
	<script src="https://cdn.bootcss.com/babel-standalone/6.22.1/babel.js"></script>
	<script src="./js/amazeui.react.js"></script>
	<script src="./js/polyfill.js"></script>
	<script src="./js/autoBind.js"></script>
</head>
<body>
	<div id="MainWindow"></div>
	<script type="text/babel">
		var Button = AMUIReact.Button;
		var Input = AMUIReact.Input;
		var Panel = AMUIReact.Panel;
		var Grid = AMUIReact.Grid;
		var Col = AMUIReact.Col;
		var Article = AMUIReact.Article;
		var Alert = AMUIReact.Alert;
		var Topbar = AMUIReact.Topbar;
		var CollapsibleNav = AMUIReact.CollapsibleNav;
		var Nav = AMUIReact.Nav;
		var NavItem = AMUIReact.NavItem;
		var Selected = AMUIReact.Selected;
		
		class DataStore {
			static getAccessKey() {
				var ak = localStorage.getItem("btcpool.accesskey");
				if (typeof(ak) != "string") {
					ak = null;
				}
				return ak;
			}
			
			static setAccessKey(ak) {
				if (typeof(ak) != "string") {
					throw "币看监控密钥必须为字符串";
				}
				
				ak = ak.trim()
				
				if (ak.length == 0) {
					throw "币看监控密钥不能为空";
				}
				if (ak.length < 20) {
					throw "币看监控密钥过短，请确认您已输入完整";
				}
				
				localStorage.setItem("btcpool.accesskey", ak.trim());
			}
			
			static hasAccessKey() {
				return this.getAccessKey() != null;
			}

			static clearAccessKey() {
				localStorage.removeItem("btcpool.accesskey");
			}
		}
		
		var HidableAlert = function(props) {
			return props.visible ? (
				<Alert amStyle={props.amStyle}>
					<p>{props.alertText}</p>
				</Alert>
			) : null;
		}
		
		function MainNavBar(props) {
			var handleSelectSubAccount = function(props) {
				if (props.active=="SelectSubAccount") {
					return false;
				}
				MainWindow.init();
			}
			var handleSwitchUser = function(props) {
				if (props.active=="SwitchUser") {
					return false;
				}
				MainWindow.switchUser();
			}
			var handleExit = function(props) {
				if (props.active=="Exit") {
					return false;
				}
				MainWindow.exit();
			}

			return (
				<Topbar brand="BTCPool算力导出工具" toggleNavKey="nav">
					<CollapsibleNav eventKey="nav">
					<Nav topbar>
						<NavItem active={props.active=="SwitchUser"} onClick={(props)=>handleSwitchUser(props)} href="#">切换用户</NavItem>
						<NavItem active={props.active=="SelectSubAccount"} onClick={(props)=>handleSelectSubAccount(props)} href="#">选择子账户</NavItem>
						<NavItem active={props.active=="Exit"} onClick={(props)=>handleExit(props)} href="#">退出</NavItem>
					</Nav>
					</CollapsibleNav>
				</Topbar>
			);
		}
		
		class InputAccessKey extends React.Component {
			state = {
				accessKey: '',
				hasAlert: false,
				alertText: '',
			}
			
			constructor(props) {
				super(props);
				autoBind(this);
			}
			
			handleAccessKeyChange(e) {
				this.setState({ accessKey: e.target.value });
			}
			
			handleClickNextStep() {
				try {
					MainWindow.saveAccessKey(this.state.accessKey);
				} catch (e) {
					this.setState({
						hasAlert: true,
						alertText: e
					});
				}
			}

			render() {
				return (
				<div>
					<MainNavBar active="SwitchUser" />
					<Panel header="请输入您从BTCPool获取的币看监控密钥">
						<HidableAlert amStyle="secondary" visible={this.state.hasAlert} alertText={this.state.alertText} />
						<Grid>
							<Col sm={8}><Input type="password" placeholder="币看监控密钥" onChange={this.handleAccessKeyChange} /></Col>
							<Col sm={2}><Button onClick={this.handleClickNextStep}>下一步</Button></Col>
						</Grid>
						<p>导出工具需要获得您的授权才能导出您在BTCPool的算力数据，而给予授权最简单的方式就是提供“币看监控密钥”。</p>
						<p>您可以<a href="https://pool.btc.com/dashboard">登录BTCPool</a>，点击右上角的“设置”按钮，然后选择“共享数据”，再点击“获取币看监控密钥”，最后，将其中的“AccessKey”粘贴到上方的输入框即可。</p>
						<p>注意，请<b>妥善保管</b>您的“币看监控密钥”，<b>不要将其提供给任何不信任的人或网站</b>。获得您的“币看监控密钥”相当于获得了您在矿池的登录状态，可以代替您在矿池进行一系列操作，包括但不限于创建子账户、切换币种等。</p>
					</Panel>
				</div>
				);
			}
		}
		
		class SelectSubAccount extends React.Component {
			subAccountData = [];

			state = {
				coinList: [
					{value:'', label:'您没有子账户'}
				],
				subAccountList: [
					{value:'', label:'请先选择币种'}
				],
				// 选中的子账户，逗号分隔
				// 全部为all
				selectedSubAccounts: '',
			}
			
			constructor(props) {
				super(props);
				autoBind(this);
			}

			componentDidMount() {
				PoolAPI.getSubAccounts().then((subAccounts)=>{
					this.subAccountData = subAccounts;
					this.updateCoinList();
				});
			}

			updateCoinList() {
				var newCoinList = [];
				for (var coinType in this.subAccountData) {
					newCoinList.push({value: coinType, label: coinType});
				}
				this.setState({
					coinList: newCoinList
				});
			}

			updateSubAccountList(coinType) {
				var newSubAccountList = [
					{value: 'all', label: '全部'}
				];
				for (var i in this.subAccountData[coinType]) {
					var account = this.subAccountData[coinType][i];
					newSubAccountList.push({value: account.puid.toString(), label: account.name});
				}
				this.setState({
					subAccountList: newSubAccountList
				});
			}

			subAccountChanged(selected) {
				console.log(selected);
			}

			render() {
				return (
				<div>
					<MainNavBar active="SelectSubAccount" />
					<Panel header="请选择您要导出的币种、子账户及导出的时间段">
						<Selected data={this.state.coinList} placeholder="选择币种" onChange={this.updateSubAccountList} />
						<Selected data={this.state.subAccountList} placeholder="选择子账户" onChange={this.subAccountChanged} multiple={true} />
					</Panel>
				</div>
				);
			}
		}

		class ExitPage extends React.Component {
			render() {
				return (
				<div>
					<MainNavBar active="Exit" />
					<p>您已退出，您的“币看监控密钥”已从浏览器移除。</p>
					<p>若想再次使用本工具，请点击导航栏上的“切换用户”按钮。</p>
				</div>
				);
			}
		}

		class PoolAPI {
			static defaultEndpoint = 'https://cn-pool.api.btc.com/v1/';

			static ak() {
				var ak = DataStore.getAccessKey();
				if (ak == null) {
					throw "币看监控密钥为空";
				}
				return ak;
			}

			static get(endpoint, api, params) {
				if (typeof(params) != 'object') {
					params = {};
				}
				params.access_key = PoolAPI.ak();
				return $.get(endpoint + api, params);
			}

			static getSubAccounts() {
				return PoolAPI.get(PoolAPI.defaultEndpoint, 'account/sub-account/morelist').then((result)=>{
					if (typeof(result) != 'object') {
						throw "获取子账户列表失败，结果不是对象：" + JSON.stringify(result);
					}
					if (result.err_no != 0) {
						throw "获取子账户列表失败：" + result.err_msg;
					}

					var list = {/*
						"BTC": [
							{"puid":1, "name":"aaa", "endpoint":"https://cn.pool.btc.com/v1/"},
							{"puid":2, "name":"xxx", "endpoint":"https://sz.pool.btc.com/v1/"},
							...
						],
						"BCH": [
							{"puid":6, "name":"fff", "endpoint":"https://us.pool.btc.com/v1/"},
							{"puid":9, "name":"xxx_bcc", "endpoint":"https://sz.pool.btc.com/v1/"},
							...
						],
						...
					*/};

					for (var i in result.data.display) {
						var accountData = result.data.display[i];
						var account = {
							puid: accountData.puid,
							name: accountData.name,
							endpoint: accountData.default_url,
						};

						if (list[accountData.coin_type] == undefined) {
							list[accountData.coin_type] = [];
						}
						list[accountData.coin_type].push(account);
					}

					return list;
				});
			}


		}
		
		class MainWindow {
			static show(content) {
				ReactDOM.render(content,document.getElementById('MainWindow'));
			}
		
			static init() {
				if (DataStore.hasAccessKey()) {
					MainWindow.show(<SelectSubAccount />);
				} else {
					MainWindow.show(<InputAccessKey />);
				}
			}

			static saveAccessKey(ak) {
				DataStore.setAccessKey(ak);
				MainWindow.show(<SelectSubAccount />);
			}

			static switchUser() {
				MainWindow.show(<InputAccessKey />);
			}

			static exit() {
				DataStore.clearAccessKey();
				MainWindow.show(<ExitPage />);
			}
		}
		
		MainWindow.init();
	</script>
</body>
</html>
